name: baking-the-image
resources:
  containers:
    - container: buildpacks-infra
      image: ghcr.io/mysticrenji/buildpacks-infra:v1.0.0

trigger:
  - main

variables:
  - group: infra_variables
  - name: tfWorkSpace
    value: $(Pipeline.Workspace)/s/

stages:
  - stage: "Terraform_Init"
    displayName: "Initialise Terraform"
    jobs:
      - job: Terraform_Init
        container: buildpacks-infra
        steps:
          - script: |
                export ARM_ACCESS_KEY=$(AR$(M_ACCESS_KEY)
                export ARM_CLIENT_ID=$(ARM_CLIENT_ID)
                export ARM_CLIENT_SECRET=$(ARM_CLIENT_SECRET)
                export ARM_SUBSCRIPTION_ID=$(ARM_SUBSCRIPTION_ID)
                export ARM_TENANT_ID=$(ARM_TENANT_ID)
                terraform init
                terraform fmt
                terraform plan -var-file=auto.tfvars
                
            workingDirectory: $(Build.SourcesDirectory)/terraform
          # - task: Cache@2
          #   displayName: "Register TF providers"
          #   inputs:
          #     key: terraform | $(Agent.OS) | "$(Build.BuildNumber)" | $(Build.SourceVersion)"
          #     path: "$(tfWorkSpace)"